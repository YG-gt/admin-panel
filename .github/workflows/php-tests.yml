name: ğŸ”’ Paranoia Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: PHP ${{ matrix.php-version }} Tests
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.1', '8.2', '8.3']
        
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: curl, mbstring, session, dom, xml, tokenizer, ctype, json
          coverage: xdebug
          tools: composer:v2

      - name: ğŸ“‹ Validate composer.json
        run: composer validate --strict

      - name: ğŸ“¦ Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ~/.composer/cache
          key: php-${{ matrix.php-version }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: php-${{ matrix.php-version }}-composer-

      - name: ğŸ”§ Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: ğŸ§ª Run PHPUnit tests
        run: |
          # Check if vendor directory exists
          ls -la vendor/bin/
          # Run tests
          ./vendor/bin/phpunit --colors=always --testdox

      - name: ğŸ“Š Run tests with coverage
        if: matrix.php-version == '8.2'
        run: |
          composer test-coverage
          ls -la coverage/

      - name: ğŸ›¡ï¸ Security tests only
        run: ./vendor/bin/phpunit --colors=always --testdox --group=security

      - name: ğŸ“ Logging tests only  
        run: ./vendor/bin/phpunit --colors=always --testdox --group=logging

      - name: ğŸ” Test specific groups
        run: |
          ./vendor/bin/phpunit --group=validation --testdox
          ./vendor/bin/phpunit --group=csrf --testdox
          ./vendor/bin/phpunit --group=rate-limiting --testdox
          ./vendor/bin/phpunit --group=authorization --testdox

  security-scan:
    name: ğŸ›¡ï¸ Security Analysis
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          
      - name: ğŸ” Check for known vulnerabilities
        run: |
          echo "ğŸ”’ Paranoia Security Check"
          echo "Checking for common PHP security issues..."
          
          # Check for potential security issues in PHP files
          echo "Checking for eval() usage..."
          if grep -r "eval(" *.php; then
            echo "âŒ Found eval() usage - potential security risk"
            exit 1
          else
            echo "âœ… No eval() found"
          fi
          
          echo "Checking for shell_exec() usage..."
          if grep -r "shell_exec\|exec\|system\|passthru" *.php; then
            echo "âš ï¸ Found shell execution functions - review needed"
          else
            echo "âœ… No dangerous shell functions found"
          fi
          
          echo "Checking for SQL injection risks..."
          if grep -r "mysql_query\|mysqli_query.*\$" *.php; then
            echo "âš ï¸ Found potential SQL injection risks"
          else
            echo "âœ… No obvious SQL injection risks"
          fi
          
          echo "ğŸ‰ Security scan completed!"

  lint:
    name: ğŸ§¹ Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          
      - name: ğŸ” PHP Syntax Check
        run: |
          echo "ğŸ” Checking PHP syntax..."
          find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \;
          echo "âœ… PHP syntax check completed!"
          
      - name: ğŸ“ Code Style Check
        run: |
          echo "ğŸ“ Basic code style checks..."
          
          # Check for mixed line endings
          if find . -name "*.php" -not -path "./vendor/*" -exec file {} \; | grep CRLF; then
            echo "âš ï¸ Found CRLF line endings - should use LF"
          else
            echo "âœ… Line endings OK"
          fi
          
          # Check for trailing whitespace
          if find . -name "*.php" -not -path "./vendor/*" -exec grep -l " $" {} \;; then
            echo "âš ï¸ Found trailing whitespace"
          else
            echo "âœ… No trailing whitespace"
          fi
          
          echo "âœ… Code style check completed!" 